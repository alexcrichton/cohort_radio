(function() {
  var script = function() {
    <%= yield %>
  };

  var new_scripts = <%= raw all_javascripts_included.to_json %>;
  var have_scripts = $['included_javascripts'];
  var need_to_load_scripts = [];
  var wrote_all = false, javascripts_loaded = false, css_needed = 0;

  var check_have_scripts = function() {
    if (wrote_all && javascripts_loaded && css_needed == 0) {
      script();
    }
  };

  for (var i = 0; i < new_scripts.length; i++) {
    var have_script = false;

    for (var j = 0; j < have_scripts.length; j++) {
      if (have_scripts[j].split('?')[0] == new_scripts[i].split('?')[0]) {
        have_script = true;
        break;
      }
    }

    if (!have_script) {
      need_to_load_scripts.unshift(new_scripts[i]);
    }
  }

  var loadNextScript = function() {
    var s = need_to_load_scripts.pop();
    if (typeof s == 'undefined') {
      javascripts_loaded = true;
      check_have_scripts();
    } else {
      $.ajax({
        url: s,
        success: loadNextScript,
        dataType: 'script'
      });

      $['included_javascripts'].push(s);
    }
  }

  loadNextScript();

  var new_css = <%= raw all_stylesheets_included.to_json %>;
  var have_css = $['included_stylesheets'];

  for (var i = 0; i < new_css.length; i++) {
    var have = false;
    for (var j = 0; j < have_css.length; j++) {
      if (have_css[j].split('?')[0] == new_css[i].split('?')[0]) {
        have = true;
        break;
      }
    }

    if (!have) {
      css_needed++;

      $.ajax({
        url: new_css[i],
        success: function(data) {
          css_needed--;
          $('head').append(
            '<style type="text\/css" rel="stylesheet">' + data + '<\/style>'
          );
          check_have_scripts();
        }
      });

      $['included_stylesheets'].push(new_css[i]);
    }
  }

  wrote_all = true
  check_have_scripts();
})();
